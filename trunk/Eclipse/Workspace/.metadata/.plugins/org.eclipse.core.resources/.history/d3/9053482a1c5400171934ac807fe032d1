package ch.mitdom.compresstutorial;

import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import org.apache.commons.compress.utils.IOUtils;
import org.apache.commons.compress.archivers.sevenz.*;
import org.apache.commons.compress.archivers.ArchiveException;
import org.apache.commons.compress.archivers.ArchiveOutputStream;
import org.apache.commons.compress.archivers.ArchiveStreamFactory;

public class Compressor7z implements ICompressor {
	File destinationPath;
	File[] source;
	File destination;
	CompressorGui compressorGui;
	
	public Compressor7z(CompressorGui compressorGui){
		this.compressorGui = compressorGui;
	}
	
	public void setDestination(File destinationPath) {
		this.destination = new File(destinationPath.getAbsolutePath());
	}

	public void setSource(File[] source) {
		this.source = source;
	}

	@Override
	public boolean compress() {
		if(source == null || destination == null) return false;
		else{
			try {
				SevenZOutputFile archive = new SevenZOutputFile(destination);					
				int index = 0;
				
				for(File file : source){
					SevenZArchiveEntry entry = archive.createArchiveEntry(file, file.getName());
					archive.putArchiveEntry(entry);
					
					FileInputStream inputStream = new FileInputStream(file);
					byte[] b = new byte[1024];
					int count = 0;
					while ((count = inputStream.read(b)) > 0) {
						archive.write(b, 0, count);
					}
					
					archive.closeArchiveEntry();
					inputStream.close();
					
					index++;
					setProgress(index, file.getName(), source.length);
				}
				
				archive.close();
				return true;				
			} 
			catch (IOException e) {
				e.printStackTrace();
			}
		}
		return false;
	}

	@Override
	public void setProgress(int progress, String fileName, int length) {
		compressorGui.setProgress(progress, fileName, length);
	}

}
